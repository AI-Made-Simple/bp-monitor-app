<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gemini BP Monitor (OAuth)</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 10px 0; }
    img { max-width: 300px; margin-top: 10px; }
    .reading { margin-top: 20px; }
    #dropZone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      margin-top: 10px;
      background-color: #f9f9f9;
    }
    #dropZone.dragover {
      background-color: #e0f7fa;
      border-color: #00bcd4;
    }
  </style>
</head>
<body>
  <h2>ðŸ“¸ Upload or Drag & Drop BP Monitor Image</h2>

  <!-- Google Sign-In -->
  <div id="g_id_onload"
       data-client_id="%GOOGLE_CLIENT_ID%"
       data-auto_prompt="false"
       data-callback="handleCredentialResponse">
  </div>
  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left">
  </div>

  <!-- Hidden until login -->
  <div id="appUI" style="display: none;">
    <input type="file" id="imageInput" accept="image/*">
    <div id="dropZone">Drop image here</div>
    <button onclick="sendToGemini()">Extract & Save</button>
    <img id="preview" />
    <div class="reading" id="output"></div>
  </div>

  <script>
    let currentImage = null;
    let accessToken = null;
    const output = document.getElementById("output");
    const dropZone = document.getElementById("dropZone");

    // Google Sign-In callback
    function handleCredentialResponse(response) {
      const jwt = response.credential;
      console.log("Google JWT:", jwt);

      // In production, exchange JWT for access token via backend
      accessToken = jwt; // For demo purposes only

      // Show app UI
      document.getElementById("appUI").style.display = "block";
      document.querySelector(".g_id_signin").style.display = "none";
    }

    // Upload input
    document.getElementById("imageInput").addEventListener("change", (e) => {
      currentImage = e.target.files[0];
      console.log("Image selected via upload:", currentImage);
      previewImage(currentImage);
    });

    // Drag & drop
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      currentImage = e.dataTransfer.files[0];
      console.log("Image dropped:", currentImage);
      previewImage(currentImage);
    });

    function previewImage(file) {
      const reader = new FileReader();
      reader.onload = () => {
        document.getElementById("preview").src = reader.result;
        console.log("Image preview loaded.");
      };
      reader.readAsDataURL(file);
    }

    async function sendToGemini() {
      if (!accessToken) {
        output.innerText = "Please sign in with Google first.";
        return;
      }

      if (!currentImage) {
        output.innerText = "Please upload or drop an image first.";
        return;
      }

      const reader = new FileReader();
      reader.onload = async () => {
        const base64Image = reader.result.split(',')[1]; // Remove data URI prefix

        const geminiPayload = {
          contents: [{
            parts: [
              { text: "Extract systolic, diastolic, and pulse readings from this blood pressure monitor image." },
              { inline_data: { mime_type: "image/jpeg", data: base64Image } }
            ]
          }]
        };

        try {
          const response = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify(geminiPayload)
          });

          const result = await response.json();
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
          console.log("Gemini response:", text);

          const match = text.match(/(?:SYS|Systolic)[:\s]*(\d{2,3}).*?(?:DIA|Diastolic)[:\s]*(\d{2,3}).*?(?:Pulse|PULSE)[:\s]*(\d{2,3})/i);
          if (match) {
            const [_, systolic, diastolic, pulse] = match;
            const date = new Date().toLocaleString();
            output.innerHTML = `
              <strong>ðŸ©º BP Reading:</strong><br>
              Systolic: ${systolic}<br>
              Diastolic: ${diastolic}<br>
              Pulse: ${pulse}<br>
              Date: ${date}
            `;
          } else {
            output.innerText = "Could not extract BP data. Try a clearer image.";
          }
        } catch (err) {
          console.error("Gemini API error:", err);
          output.innerText = "Error calling Gemini API. Check console for details.";
        }
      };

      reader.readAsDataURL(currentImage);
    }
  </script>
</body>
</html>
