<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gemini BP Monitor</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button { margin: 10px 0; }
    img { max-width: 100%; margin-top: 10px; }
    .reading { margin-top: 20px; white-space: pre-wrap; }
    #dropZone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      margin-top: 10px;
      background-color: #f9f9f9;
    }
    #dropZone.dragover {
      background-color: #e0f7fa;
      border-color: #00bcd4;
    }
  </style>
</head>
<body>
  <h2>ðŸ“¸ Upload or Drag & Drop BP Monitor Image</h2>

  <div id="g_id_onload"
       data-client_id="355753802847-lpubtdhub8imc4egn27ffe0l8t5n3v5l.apps.googleusercontent.com"
       data-auto_prompt="true"
       data-auto_select="true"
       data-callback="handleCredentialResponse">
  </div>
  <div class="g_id_signin"
       data-client_id="355753802847-lpubtdhub8imc4egn27ffe0l8t5n3v5l.apps.googleusercontent.com"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left">
  </div>

  <div id="appUI" style="display: none;">
    <input type="file" id="imageInput" accept="image/*">
    <div id="dropZone">Drop image here</div>
    <button onclick="sendToGemini()">Extract & Save</button>
    <img id="preview" />
    <div class="reading" id="output"></div>
  </div>

  <script>
    let currentImage = null;
    let accessToken = null;
    const output = document.getElementById("output");
    const dropZone = document.getElementById("dropZone");

    window.onload = () => {
      const savedToken = localStorage.getItem("google_jwt");
      if (savedToken) {
        accessToken = savedToken;
        console.log("Restored JWT from localStorage.");
        document.getElementById("appUI").style.display = "block";
      } else {
        google.accounts.id.prompt((notification) => {
          console.log("One Tap status:", notification);
        });
      }
    };

    function handleCredentialResponse(response) {
      accessToken = response.credential;
      localStorage.setItem("google_jwt", accessToken);
      console.log("Google JWT:", accessToken);
      document.getElementById("appUI").style.display = "block";
    }

    document.getElementById("imageInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        currentImage = file;
        document.getElementById("preview").src = URL.createObjectURL(file);
        console.log("Image preview loaded.");
      }
    });

    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) {
        currentImage = file;
        document.getElementById("preview").src = URL.createObjectURL(file);
        console.log("Image preview loaded.");
      }
    });

    async function sendToGemini() {
      if (!currentImage) {
        output.innerText = "Please upload an image.";
        return;
      }

      const reader = new FileReader();
      reader.onload = async function (e) {
        const dataUri = e.target.result;
        console.log("Sending original image to Gemini:", {
          mimeType: currentImage.type,
          imageDataUri: dataUri.slice(0, 100) + "..."
        });

        try {
          const response = await fetch("/api/gemini", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              imageDataUri: dataUri,
              mimeType: currentImage.type
            })
          });

          const result = await response.json();
          console.log("Gemini response:", result);
          output.innerText = result.text || "No data found.";
        } catch (err) {
          console.error("Error calling Gemini:", err);
          output.innerText = "Error extracting data. Please try again.";
        }
      };

      reader.readAsDataURL(currentImage);
    }
  </script>
</body>
</html>
