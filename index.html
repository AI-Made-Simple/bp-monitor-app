<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gemini BP Monitor</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, button { margin: 10px 0; }
    img { max-width: 100%; margin-top: 10px; }
    .reading { margin-top: 20px; white-space: pre-wrap; }
    #dropZone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      margin-top: 10px;
      background-color: #f9f9f9;
    }
    #dropZone.dragover {
      background-color: #e0f7fa;
      border-color: #00bcd4;
    }
  </style>
</head>
<body>
  <h2>ðŸ“¸ Upload or Drag & Drop BP Monitor Image</h2>

  <!-- Google Sign-In -->
  <div id="g_id_onload"
       data-client_id="355753802847-lpubtdhub8imc4egn27ffe0l8t5n3v5l.apps.googleusercontent.com"
       data-auto_prompt="false"
       data-callback="handleCredentialResponse">
  </div>
  <div class="g_id_signin"
       data-client_id="355753802847-lpubtdhub8imc4egn27ffe0l8t5n3v5l.apps.googleusercontent.com"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular"
       data-logo_alignment="left">
  </div>

  <!-- App UI (hidden until login) -->
  <div id="appUI" style="display: none;">
    <input type="file" id="imageInput" accept="image/*">
    <div id="dropZone">Drop image here</div>
    <button onclick="sendToGemini()">Extract & Save</button>
    <img id="preview" />
    <div class="reading" id="output"></div>
  </div>

  <script>
    let currentImage = null;
    let accessToken = null;
    const output = document.getElementById("output");
    const dropZone = document.getElementById("dropZone");

    function handleCredentialResponse(response) {
      accessToken = response.credential;
      console.log("Google JWT:", accessToken);
      document.getElementById("appUI").style.display = "block";
    }

    document.getElementById("imageInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        currentImage = file;
        document.getElementById("preview").src = URL.createObjectURL(file);
        console.log("Image preview loaded.");
      }
    });

    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("dragover");
    });

    dropZone.addEventListener("dragleave", () => {
      dropZone.classList.remove("dragover");
    });

    dropZone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("dragover");
      const file = e.dataTransfer.files[0];
      if (file) {
        currentImage = file;
        document.getElementById("preview").src = URL.createObjectURL(file);
        console.log("Image preview loaded.");
      }
    });

    function resizeImage(file, maxWidth = 800, maxHeight = 800, callback) {
      const img = new Image();
      const reader = new FileReader();

      reader.onload = function (e) {
        img.src = e.target.result;
      };

      img.onload = function () {
        const canvas = document.createElement("canvas");
        let width = img.width;
        let height = img.height;

        if (width > maxWidth || height > maxHeight) {
          const scale = Math.min(maxWidth / width, maxHeight / height);
          width *= scale;
          height *= scale;
        }

        canvas.width = width;
        canvas.height = height;
        canvas.getContext("2d").drawImage(img, 0, 0, width, height);
        const resizedDataUrl = canvas.toDataURL("image/jpeg", 0.7); // 70% quality
        callback(resizedDataUrl.split(',')[1]); // base64 only
      };

      reader.readAsDataURL(file);
    }

    async function sendToGemini() {
      if (!currentImage || !accessToken) {
        output.innerText = "Please sign in and upload an image.";
        return;
      }

      resizeImage(currentImage, 800, 800, async (base64Image) => {
        try {
          const response = await fetch("/api/gemini", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              imageBase64: base64Image,
              jwt: accessToken,
              mimeType: currentImage.type
            })
          });

          const result = await response.json();
          console.log("Gemini response:", result);
          output.innerText = result.text || "No data found.";
        } catch (err) {
          console.error("Error calling Gemini:", err);
          output.innerText = "Error extracting data. Please try again.";
        }
      });
    }
  </script>
</body>
</html>


