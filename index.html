<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Pressure Extractor</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #drop-area { border: 2px dashed #ccc; width: 300px; height: 200px; margin: 20px auto; padding: 20px; }
        #drop-area.highlight { border-color: purple; }
        #preview { width: 100%; max-width: 400px; display: none; }
        #result { margin-top: 20px; font-size: 18px; }
        input { margin: 10px; }
    </style>
</head>
<body>
    <h1>Blood Pressure Photo Extractor</h1>
    <p>Drag and drop a photo of your blood pressure monitor here or click to upload.</p>
    
    <div id="drop-area">
        <p>Drop image here or click to upload</p>
        <input type="file" id="upload" accept="image/*" style="display: none;">
    </div>
    <img id="preview" alt="Preview">
    
    <br>
    <button id="process">Process Image</button>
    
    <div id="result"></div>

    <script>
        const dropArea = document.getElementById('drop-area');
        const uploadInput = document.getElementById('upload');
        const preview = document.getElementById('preview');
        const processButton = document.getElementById('process');
        const resultDiv = document.getElementById('result');

        let imageDataUrl = null;

        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
        });

        dropArea.addEventListener('drop', handleDrop, false);
        dropArea.addEventListener('click', () => uploadInput.click());

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        uploadInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imageDataUrl = e.target.result;
                        preview.src = imageDataUrl;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Please upload an image file.');
                }
            }
        }

        // Process image by calling serverless function
        processButton.addEventListener('click', async () => {
            if (!imageDataUrl) {
                alert('Please upload an image first.');
                return;
            }

            resultDiv.innerHTML = 'Processing...';

            try {
                // Base64 encode the image (remove data URL prefix)
                const base64Image = imageDataUrl.split(',')[1];

                const response = await fetch('/api/extract', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ base64Image })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }

                const parsed = await response.json();

                resultDiv.innerHTML = `
                    <strong>SYS:</strong> ${parsed.sys} mmHg<br>
                    <strong>DIA:</strong> ${parsed.dia} mmHg<br>
                    <strong>PULSE:</strong> ${parsed.pulse} /min
                `;
            } catch (err) {
                console.error('Error processing image:', err);
                resultDiv.innerHTML = 'Error processing image. Try again.';
            }
        });
    </script>
</body>
</html>
